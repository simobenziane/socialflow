{
    "name":  "W-Agent1: Config Generator v16",
    "nodes":  [
                  {
                      "parameters":  {
                                         "httpMethod":  "POST",
                                         "path":  "w-agent1-config",
                                         "responseMode":  "responseNode",
                                         "options":  {
                                                         "responseHeaders":  {
                                                                                 "entries":  [
                                                                                                 {
                                                                                                     "name":  "Access-Control-Allow-Origin",
                                                                                                     "value":  "*"
                                                                                                 }
                                                                                             ]
                                                                             }
                                                     }
                                     },
                      "type":  "n8n-nodes-base.webhook",
                      "typeVersion":  2.1,
                      "position":  [
                                       0,
                                       300
                                   ],
                      "id":  "agent1-webhook",
                      "name":  "Webhook Trigger",
                      "webhookId":  "w-agent1-config-webhook"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "/**\n * W-Agent1 v16: Prepare Context\n * Validates input and prepares context for generation steps\n * Phase 2.7: Added isEnglish flag for language-specific prompts\n */\nconst fs = require(\u0027fs\u0027);\n\nconsole.log(\u0027[Agent1] Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â\u0027);\nconsole.log(\u0027[Agent1] Starting Config Generator v16 (Multi-Step)\u0027);\nconsole.log(\u0027[Agent1] Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â\u0027);\n\nconst input = $input.first().json || {};\nconst body = input.body || input;\n\nconst CONFIG_BASE = \u0027/data/clients/_config\u0027;\nconst SETTINGS_PATH = `${CONFIG_BASE}/settings.json`;\nconst startTime = Date.now();\n\nconst slug = body.slug;\nconst onboarding = body.onboarding;\n\nif (!slug) {\n  return [{ json: { success: false, error: \u0027Missing slug\u0027 } }];\n}\nif (!onboarding?.business_description) {\n  return [{ json: { success: false, error: \u0027Missing business_description\u0027 } }];\n}\n\nconst lang = onboarding.language || \u0027fr\u0027;\nconst isEnglish = lang === \u0027en\u0027;\nconst langMap = { fr: \u0027French\u0027, de: \u0027German\u0027, en: \u0027English\u0027 };\nconst langName = langMap[lang] || \u0027French\u0027;\n\nconsole.log(`[Agent1] Client: ${slug}, Language: ${langName}, isEnglish: ${isEnglish}`);\n\nlet settings;\ntry {\n  settings = JSON.parse(fs.readFileSync(SETTINGS_PATH, \u0027utf8\u0027));\n} catch (e) {\n  return [{ json: { success: false, error: \u0027Cannot load settings.json\u0027 } }];\n}\n\nconst OLLAMA_URL = settings.ollama?.url_docker || \u0027http://host.docker.internal:11434/api/generate\u0027;\nconst OLLAMA_MODEL = settings.ollama?.models?.config_generator || \u0027llama3.2:3b\u0027;\n\nconsole.log(`[Agent1] Model: ${OLLAMA_MODEL}`);\n\nreturn [{ json: {\n  slug,\n  onboarding,\n  lang,\n  isEnglish,\n  langName,\n  ollama_url: OLLAMA_URL,\n  ollama_model: OLLAMA_MODEL,\n  _start_time: startTime\n} }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       240,
                                       300
                                   ],
                      "id":  "agent1-prepare",
                      "name":  "Prepare Context"
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $json.ollama_url }}",
                                         "sendBody":  true,
                                         "specifyBody":  "json",
                                         "jsonBody":  "={\n  \"model\": {{ JSON.stringify($json.ollama_model) }},\n  \"prompt\": {{ $json.isEnglish ? JSON.stringify(`You are a brand strategist. Write a caption brief (80-100 words) for ${$json.onboarding.business_name || $json.slug}.\n\nBusiness: ${($json.onboarding.business_description || \u0027\u0027).substring(0, 150)}\nTone: ${$json.onboarding.brand_personality || \u0027professional and friendly\u0027}\n\nInclude: brand voice, caption structure (hook + body + CTA), 3 example hooks.\n\nExample brief:\n\"Warm, artisan feel. Each caption: catchy hook (10 words), sensory description, call to action. Hooks: \u0027Fresh from the oven...\u0027, \u0027Taste the difference...\u0027, \u0027Your morning ritual...\u0027 No prices or superlatives.\"\n\nBrief:`) : JSON.stringify(`Tu es stratÃƒÂ¨ge de marque. Ãƒâ€°cris un brief de captions (80-100 mots) pour ${$json.onboarding.business_name || $json.slug}.\n\nEntreprise: ${($json.onboarding.business_description || \u0027\u0027).substring(0, 150)}\nTon: ${$json.onboarding.brand_personality || \u0027chaleureux et professionnel\u0027}\n\nInclure: voix de marque, structure (accroche + corps + CTA), 3 exemples d\u0027accroches.\n\nExemple de brief:\n\"Ton chaleureux, artisanal. Chaque lÃƒÂ©gende: accroche captivante (10 mots), description sensorielle, appel ÃƒÂ  l\u0027action. Accroches: \u0027FraÃƒÂ®chement sorti du four...\u0027, \u0027GoÃƒÂ»tez la diffÃƒÂ©rence...\u0027, \u0027Votre rituel du matin...\u0027 Pas de prix ni superlatifs.\"\n\nBrief:`) }},\n  \"stream\": false,\n  \"options\": { \"temperature\": 0.4, \"num_predict\": 200 }\n}",
                                         "options":  {
                                                         "timeout":  120000
                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.3,
                      "position":  [
                                       480,
                                       300
                                   ],
                      "id":  "agent1-gen-brief",
                      "name":  "Generate Brief",
                      "onError":  "continueRegularOutput"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const response = $json;\nconst prev = $(\u0027Prepare Context\u0027).item.json;\n\nlet briefTxt = \u0027\u0027;\n\nif (!response.response) {\n  console.log(\u0027[Agent1] Brief failed, using fallback\u0027);\n  if (prev.isEnglish) {\n    briefTxt = `# ${prev.onboarding.business_name || prev.slug}\\n\\nWarm and professional tone. Each post should hook, describe, and call to action.\\n\\nExample hooks:\\n- Discover...\\n- You\u0027ll love...\\n- The secret to...\\n\\nRules: no prices, no superlatives.`;\n  } else {\n    briefTxt = `# ${prev.onboarding.business_name || prev.slug}\\n\\nTon chaleureux et professionnel. Chaque post doit accrocher, dÃƒÂ©crire, et inviter ÃƒÂ  l\u0027action.\\n\\nExemples d\u0027accroches:\\n- DÃƒÂ©couvrez...\\n- Vous allez adorer...\\n- Le secret de...\\n\\nRÃƒÂ¨gles: pas de prix, pas de superlatifs.`;\n  }\n} else {\n  briefTxt = response.response.trim()\n    .replace(/^```[a-z]*\\n?/gm, \u0027\u0027).replace(/```$/gm, \u0027\u0027)\n    .replace(/^(Here|Sure|Okay|Certainly|Voici|D\u0027accord)[^\\n]*\\n+/i, \u0027\u0027)\n    .trim();\n}\n\nconsole.log(`[Agent1] Brief: ${briefTxt.length} chars`);\n\nreturn [{ json: { ...prev, brief_txt: briefTxt } }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       720,
                                       300
                                   ],
                      "id":  "agent1-extract-brief",
                      "name":  "Extract Brief"
                  },
                  {
                      "parameters":  {
                                         "method":  "POST",
                                         "url":  "={{ $json.ollama_url }}",
                                         "sendBody":  true,
                                         "specifyBody":  "json",
                                         "jsonBody":  "={\n  \"model\": {{ JSON.stringify($json.ollama_model) }},\n  \"prompt\": {{ $json.isEnglish ? JSON.stringify(`Generate 12 relevant hashtags for ${$json.onboarding.business_name || $json.slug} (${($json.onboarding.business_description || \u0027\u0027).substring(0, 80)}).\n\nExample: #bakery #artisan #freshbread #local #handmade #quality #homemade #tradition #croissant #pastry #boulangerie #goodmorning\n\nHashtags:\n#`) : JSON.stringify(`GÃƒÂ©nÃƒÂ¨re 12 hashtags pertinents pour ${$json.onboarding.business_name || $json.slug} (${($json.onboarding.business_description || \u0027\u0027).substring(0, 80)}).\n\nExemple: #boulangerie #artisan #painfrais #local #faitmaison #qualitÃƒÂ© #tradition #croissant #patisserie #viennoiserie #petitdejeuner #gourmand\n\nHashtags:\n#`) }},\n  \"stream\": false,\n  \"options\": { \"temperature\": 0.5, \"num_predict\": 100 }\n}",
                                         "options":  {
                                                         "timeout":  60000
                                                     }
                                     },
                      "type":  "n8n-nodes-base.httpRequest",
                      "typeVersion":  4.3,
                      "position":  [
                                       960,
                                       300
                                   ],
                      "id":  "agent1-gen-hashtags",
                      "name":  "Generate Hashtags",
                      "onError":  "continueRegularOutput"
                  },
                  {
                      "parameters":  {
                                         "jsCode":  "const fs = require(\u0027fs\u0027);\nconst path = require(\u0027path\u0027);\n\nconst response = $json;\nconst prev = $(\u0027Extract Brief\u0027).item.json;\n\nlet hashtagsTxt = \u0027#business #quality\u0027;\n\nif (response.response) {\n  const raw = response.response.trim();\n  const tags = raw.match(/#[\\w\\u00C0-\\u024F]+/g) || [];\n  if (tags.length \u003e 0) {\n    hashtagsTxt = [...new Set(tags)].slice(0, 15).join(\u0027 \u0027);\n  }\n}\n\nconsole.log(`[Agent1] Hashtags: ${hashtagsTxt}`);\n\n// Build client.yaml from template (no LLM needed)\n// YAML escaping: handle quotes, colons, special chars, newlines\nfunction escapeYamlString(s, maxLen = 200) {\n  if (!s) return \u0027\u0027;\n  let cleaned = s\n    .replace(/\\\\/g, \u0027\\\\\\\\\u0027)     // Escape backslashes first\n    .replace(/\"/g, \u0027\\\\\"\u0027)       // Escape double quotes\n    .replace(/\\n/g, \u0027 \u0027)         // Collapse newlines to spaces\n    .replace(/\\r/g, \u0027\u0027)          // Remove carriage returns\n    .replace(/\\t/g, \u0027 \u0027)         // Convert tabs to spaces\n    .trim();\n  return cleaned.substring(0, maxLen);\n}\n\n// For description field, use YAML block scalar (safer for multi-line)\nfunction escapeYamlBlock(s, maxLen = 500) {\n  if (!s) return \u0027\u0027;\n  return s\n    .replace(/\\r\\n/g, \u0027\\n\u0027)     // Normalize line endings\n    .replace(/\\r/g, \u0027\\n\u0027)        // Handle CR\n    .split(\u0027\\n\u0027)\n    .map(line =\u003e \u0027    \u0027 + line.trim())  // Indent each line for YAML block\n    .join(\u0027\\n\u0027)\n    .substring(0, maxLen);\n}\n\nconst clientYaml = `name: \"${escapeYamlString(prev.onboarding.business_name || prev.slug)}\"\nslug: \"${prev.slug}\"\nis_active: true\nlanguage: \"${prev.lang}\"\ntimezone: \"Europe/Berlin\"\n\nbrand:\n  voice: \"${escapeYamlString(prev.onboarding.brand_personality)}\"\n  target_audience: \"${escapeYamlString(prev.onboarding.target_audience)}\"\n  description: |\n${escapeYamlBlock(prev.onboarding.business_description)}`;\n\n// ============================================\n// WRITE FILES TO FILESYSTEM\n// ============================================\nconst CLIENT_DIR = `/data/clients/${prev.slug}`;\nconst filesWritten = [];\n\ntry {\n  // Create client directory if it doesn\u0027t exist\n  if (!fs.existsSync(CLIENT_DIR)) {\n    fs.mkdirSync(CLIENT_DIR, { recursive: true });\n    console.log(`[Agent1] Created directory: ${CLIENT_DIR}`);\n  }\n\n  // Write client.yaml\n  const clientYamlPath = path.join(CLIENT_DIR, \u0027client.yaml\u0027);\n  fs.writeFileSync(clientYamlPath, clientYaml, \u0027utf8\u0027);\n  filesWritten.push(\u0027client.yaml\u0027);\n  console.log(`[Agent1] Wrote: ${clientYamlPath}`);\n\n  // Write brief.txt\n  const briefPath = path.join(CLIENT_DIR, \u0027brief.txt\u0027);\n  fs.writeFileSync(briefPath, prev.brief_txt, \u0027utf8\u0027);\n  filesWritten.push(\u0027brief.txt\u0027);\n  console.log(`[Agent1] Wrote: ${briefPath}`);\n\n  // Write hashtags.txt\n  const hashtagsPath = path.join(CLIENT_DIR, \u0027hashtags.txt\u0027);\n  fs.writeFileSync(hashtagsPath, hashtagsTxt, \u0027utf8\u0027);\n  filesWritten.push(\u0027hashtags.txt\u0027);\n  console.log(`[Agent1] Wrote: ${hashtagsPath}`);\n\n} catch (err) {\n  console.error(`[Agent1] Error writing files: ${err.message}`);\n  return [{ json: {\n    success: false,\n    error: `Failed to write config files: ${err.message}`,\n    error_code: \u0027FILE_WRITE_ERROR\u0027\n  } }];\n}\n\nconst elapsed = Date.now() - prev._start_time;\nconsole.log(`[Agent1] Done in ${elapsed}ms, wrote ${filesWritten.length} files`);\n\nreturn [{ json: {\n  success: true,\n  message: `Configuration generated and saved to ${CLIENT_DIR}`,\n  data: {\n    config: {\n      brief_txt: prev.brief_txt,\n      brief_short_txt: \u0027\u0027,\n      hashtags_txt: hashtagsTxt,\n      client_yaml: clientYaml\n    },\n    client_slug: prev.slug,\n    files_written: filesWritten,\n    client_dir: CLIENT_DIR\n  }\n} }];"
                                     },
                      "type":  "n8n-nodes-base.code",
                      "typeVersion":  2,
                      "position":  [
                                       1200,
                                       300
                                   ],
                      "id":  "agent1-build-response",
                      "name":  "Build Response"
                  },
                  {
                      "parameters":  {
                                         "respondWith":  "json",
                                         "responseBody":  "={{ $json }}",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.respondToWebhook",
                      "typeVersion":  1.1,
                      "position":  [
                                       1440,
                                       300
                                   ],
                      "id":  "agent1-respond",
                      "name":  "Respond"
                  }
              ],
    "connections":  {
                        "Webhook Trigger":  {
                                                "main":  [
                                                             [
                                                                 {
                                                                     "node":  "Prepare Context",
                                                                     "type":  "main",
                                                                     "index":  0
                                                                 }
                                                             ]
                                                         ]
                                            },
                        "Prepare Context":  {
                                                "main":  [
                                                             [
                                                                 {
                                                                     "node":  "Generate Brief",
                                                                     "type":  "main",
                                                                     "index":  0
                                                                 }
                                                             ]
                                                         ]
                                            },
                        "Generate Brief":  {
                                               "main":  [
                                                            [
                                                                {
                                                                    "node":  "Extract Brief",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ]
                                                        ]
                                           },
                        "Extract Brief":  {
                                              "main":  [
                                                           [
                                                               {
                                                                   "node":  "Generate Hashtags",
                                                                   "type":  "main",
                                                                   "index":  0
                                                               }
                                                           ]
                                                       ]
                                          },
                        "Generate Hashtags":  {
                                                  "main":  [
                                                               [
                                                                   {
                                                                       "node":  "Build Response",
                                                                       "type":  "main",
                                                                       "index":  0
                                                                   }
                                                               ]
                                                           ]
                                              },
                        "Build Response":  {
                                               "main":  [
                                                            [
                                                                {
                                                                    "node":  "Respond",
                                                                    "type":  "main",
                                                                    "index":  0
                                                                }
                                                            ]
                                                        ]
                                           }
                    },
    "pinData":  {

                },
    "settings":  {
                     "executionOrder":  "v1"
                 },
    "staticData":  null,
    "tags":  [

             ],
    "triggerCount":  0,
    "versionId":  "dadf6398-b30f-4e6f-af33-87b0078d3deb",
    "active":  false
}